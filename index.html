<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matterport SDK - Navigate to Sweep</title>
    <style>
        #matterport-container {
            width: 800px;
            height: 600px;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }

 	#id-map-table {
            border-collapse: collapse;
            margin-top: 20px;
            width: 10px;
            table-layout: auto;
        }

        #id-map-table th,
        #id-map-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
            white-space: nowrap;
        }

        #id-map-table th {
            background-color: #f0f0f0;
        }
        #legacy-navigation {
            margin-top: 20px;
        }

        #model-select {
            margin-top: 20px;
   	}
	#buttons {
	    padding-bottom: 5px;
	}

    </style>
    <script src="https://static.matterport.com/showcase-sdk/latest.js"></script>
</head>

<body>
    <h1>Matterport SDK - Navigate to Sweep</h1>

    <div id="matterport-container">
        <iframe id="matterport-iframe" width="100%" height="100%" frameborder="0" allowfullscreen
            allow="xr-spatial-tracking"></iframe>
    </div>

    <div>
        <p id="feedback"></p>
        <div id="current-sweep-id"></div>
        <div id="legacy-sweep-id"></div>
    </div>

    <div id="legacy-navigation">
        <h2>Navigate to Sweep</h2>
	<div id="buttons">
        <label for="sweepId">Enter Sweep ID:</label>
        <input type="text" id="sweepId" name="sweepId">
        <button id="navigateToSweep">Go to Sweep</button>
	</div>
	<div id="buttons">	
        <label for="legacySweepId">Enter Pano ID:</label>
        <input type="text" id="legacySweepId" name="legacySweepId">
        <button id="navigateToLegacySweep">Go to Legacy Sweep</button>
        </div>
	<p id="legacyFeedback"></p>
    </div>

    <div id="model-select">
        <h2>Change Model</h2>
        <label for="modelId">Enter Model ID:</label>
        <input type="text" id="modelId" name="modelId">
        <button id="changeModel">Change Model</button>
        <p id="modelFeedback"></p>
    </div>

    <h2>Sweep ID Conversion Table</h2>
    <table id="id-map-table">
        <thead>
            <tr>
                <th>Sweep #</th>
                <th>Sweep ID</th>
                <th>Pano ID</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>

    <script>
        const iframe = document.getElementById('matterport-iframe');
        const sweepIdInput = document.getElementById('sweepId');
        const navigateButton = document.getElementById('navigateToSweep');
        const feedbackElement = document.getElementById('feedback');
        const currentSweepIdElement = document.getElementById('current-sweep-id');
        const legacySweepIdElement = document.getElementById('legacy-sweep-id');
        const idMapTableBody = document.querySelector('#id-map-table tbody');

        // Legacy Navigation Elements
        const legacySweepIdInput = document.getElementById('legacySweepId');
        const navigateToLegacySweepButton = document.getElementById('navigateToLegacySweep');
        const legacyFeedbackElement = document.getElementById('legacyFeedback');

        // Model Change Elements
        const modelIdInput = document.getElementById('modelId');
        const changeModelButton = document.getElementById('changeModel');
        const modelFeedbackElement = document.getElementById('modelFeedback');

        let showcaseSdk = null;
        let idMap = null;
        let sweepLabels = {};
        let currentModelSid = 'as9m4eFKdE6'; // Initial model SID

        // **REPLACE WITH YOUR ACTUAL MATTERPORT SDK KEY**
        const sdkKey = '21bhgy7i4hrk6y6h43k30tf7a';

        // Replace with your Matterport Showcase URL (containing the model SID)
        let showcaseUrl = `https://my.matterport.com/show/?m=${currentModelSid}&qs=1&play=1`;

        iframe.src = showcaseUrl;

        iframe.onload = async () => {
            await initializeSdkAndData();
        };

        async function initializeSdkAndData() {
            try {
                showcaseSdk = await window.MP_SDK.connect(iframe, sdkKey, "");
                console.log('Matterport SDK connected:', showcaseSdk);

                const urlParams = new URLSearchParams(showcaseUrl.split('?')[1]);
                currentModelSid = urlParams.get('m');
                if (!currentModelSid) {
                    console.error('Model SID not found in the showcase URL.');
                    feedbackElement.textContent = 'Error: Model SID not found.';
                    return;
                }

                feedbackElement.textContent = 'Matterport Showcase loaded.';

                try {
                    idMap = await showcaseSdk.Sweep.Conversion.createIdMap();
                    console.log("ID Map created:", idMap);

                    // Fetch sweep labels using getLabelFromId
                    try {
                        for (const currentId in idMap) {
                            if (idMap.hasOwnProperty(currentId)) {
                                try {
                                    const label = await showcaseSdk.Sweep.Conversion.getLabelFromId(currentId);
                                    sweepLabels[currentId] = label || "N/A";
                                } catch (labelError) {
                                    console.error(`Error getting label for ${currentId}:`, labelError);
                                    sweepLabels[currentId] = "Error";
                                }
                            }
                        }
                        console.log("Sweep Labels:", sweepLabels);
                    } catch (labelFetchError) {
                        console.error("Error fetching sweep labels:", labelFetchError);
                        feedbackElement.textContent = "Error: Could not fetch sweep labels.";
                        sweepLabels = {};
                    }

                    displayIdMapTable();

                } catch (mapError) {
                    console.error("Error creating ID map:", mapError);
                    feedbackElement.textContent = "Error: Could not create ID map.";
                    return;
                }

                if (showcaseSdk) {
                    try {
                        const currentSweep = await showcaseSdk.Sweep.current.get();
                        if (currentSweep && currentSweep.id) {
                            currentSweepIdElement.textContent = "Current Sweep ID: " + currentSweep.id;
                            const legacyId = idMap[currentSweep.id] || "N/A";
                            legacySweepIdElement.textContent = "Legacy Sweep ID: " + legacyId;
                        }
                    } catch (error) {
                        console.error("Error getting initial sweep:", error);
                    }
                }

                showcaseSdk.Sweep.current.subscribe(async currentSweep => {
                    if (currentSweep && currentSweep.id) {
                        currentSweepIdElement.textContent = "Current Sweep ID: " + currentSweep.id;
                        const legacyId = idMap[currentSweep.id] || "N/A";
                        legacySweepIdElement.textContent = "Current Pano ID: " + legacyId;
                    }
                });


            } catch (e) {
                console.error('Error connecting to Matterport SDK:', e);
                feedbackElement.textContent = 'Error loading Matterport Showcase.';
            }
        }

        navigateButton.addEventListener('click', async () => {
            if (!showcaseSdk) {
                feedbackElement.textContent = 'Matterport Showcase not yet loaded.';
                return;
            }

            const sweepId = sweepIdInput.value.trim();
            if (!sweepId) {
                feedbackElement.textContent = 'Please enter a Sweep ID.';
                return;
            }

            try {
                await showcaseSdk.Sweep.moveTo(sweepId, {
                    transition: "transition.fly"
                });
                feedbackElement.textContent = `Navigated to sweep: ${sweepId}`;
            } catch (error) {
                console.error('Error navigating to sweep:', error);
                feedbackElement.textContent = `Error navigating to sweep: ${error.message || 'Invalid Sweep ID'}`;
            }
        });

        function displayIdMapTable() {
            if (!idMap || Object.keys(idMap).length === 0) {
                idMapTableBody.innerHTML = '<tr><td colspan="3">No sweep ID conversions available.</td></tr>';
                return;
            }

            let tableRows = [];
            for (const currentId in idMap) {
                if (idMap.hasOwnProperty(currentId)) {
                    const legacyId = idMap[currentId];
                    const label = sweepLabels[currentId] || "N/A";
                    tableRows.push({ label: label, currentId: currentId, legacyId: legacyId });
                }
            }

            tableRows.sort((a, b) => {
                const labelA = a.label.toLowerCase();
                const labelB = b.label.toLowerCase();

                const extractNumber = (str) => {
                    const match = str.match(/(\d+)/);
                    return match ? parseInt(match[0], 10) : Infinity;
                };

                const numA = extractNumber(labelA);
                const numB = extractNumber(labelB);

                if (numA !== Infinity && numB !== Infinity) {
                    return numA - numB;
                } else if (numA === numB) {
                    return labelA.localeCompare(labelB);
                } else {
                    return numA === Infinity ? -1 : 1;
                }
            });

            let tableHTML = '';
            tableRows.forEach(row => {
                tableHTML += `<tr><td>${row.label}</td><td>${row.currentId}</td><td>${row.legacyId}</td></tr>`;
            });

            idMapTableBody.innerHTML = tableHTML;
        }

        // --- Legacy Navigation Functionality ---
        navigateToLegacySweepButton.addEventListener('click', async () => {
            if (!showcaseSdk) {
                legacyFeedbackElement.textContent = 'Matterport Showcase not yet loaded.';
                return;
            }

            const legacyId = legacySweepIdInput.value.trim();
            if (!legacyId) {
                legacyFeedbackElement.textContent = 'Please enter a Pano ID.';
                return;
            }

            // Reverse lookup in idMap
            let currentId = null;
            for (const curr in idMap) {
                if (idMap.hasOwnProperty(curr) && idMap[curr] === legacyId) {
                    currentId = curr;
                    break;
                }
            }

            if (!currentId) {
                legacyFeedbackElement.textContent = `Legacy Sweep ID "${legacyId}" not found.`;
                return;
            }

            try {
                await showcaseSdk.Sweep.moveTo(currentId, {
                    transition: "transition.fly"
                });
                legacyFeedbackElement.textContent = `Navigated to sweep with Legacy ID: ${legacyId}`;
            } catch (error) {
                console.error('Error navigating to sweep:', error);
                legacyFeedbackElement.textContent = `Error navigating: ${error.message || 'Invalid Sweep ID'}`;
            }
        });

        // --- Model Change Functionality ---
        changeModelButton.addEventListener('click', async () => {
            const newModelId = modelIdInput.value.trim();
            if (!newModelId) {
                modelFeedbackElement.textContent = 'Please enter a Model ID.';
                return;
            }

            currentModelSid = newModelId;
            showcaseUrl = `https://my.matterport.com/show/?m=${currentModelSid}&qs=1&play=1`;
            iframe.src = showcaseUrl; // Reload the iframe with the new model

            // Re-initialize SDK and data after model change
            iframe.onload = async () => {
                await initializeSdkAndData();
            };

            modelFeedbackElement.textContent = `Model changed to: ${newModelId}`;
        });

    </script>

</body>

</html>
